# 资源管线与打包约束

## 目标

- 资源构建必须可复现、可缓存、可审计（相同输入产生相同产物）。
- 资源引用必须稳定、可版本化（ID/路径/哈希语义一致），避免“换一张图全崩”。
- 资源装载必须与玩法/渲染解耦：运行期只按契约读取已打包产物，不执行导入逻辑。

## 资源范围

- 图像：UI 贴图、图标、tile/实体贴图、九宫格面板皮肤。
- 字体：UI 字体、等宽调试字体（如需要）。
- 音频：SFX/BGM（若启用）。
- 数据：配方/物品定义与本地化文本（与 mod/content 契约联动）。

## 管线分工（职责边界）

### 1) `tools`：导入与打包（构建期）

- 输入：原始资源（PNG/OGG/TTF/JSON 等）。
- 输出：运行期产物（包文件/目录）、资源清单（manifest）与指纹（fingerprint）。
- 强约束：
  - 产物必须包含版本号与格式标识（fail-fast）。
  - 产物必须可校验（哈希/大小/条目计数）。
  - 构建必须可增量：按内容哈希缓存，避免每次全量重打包。

### 2) `runtime`：装载与校验（运行期）

- 只做“读取 + 校验 + 映射”，不做导入、不依赖图形工具链。
- 资源清单与指纹必须参与存档/联机一致性校验（与 mod 指纹策略一致）。

### 3) `platform`：渲染后端（运行期）

- 只接触“已准备好的渲染命令与已装载资源句柄”，不理解资源打包格式与路径策略。

## 标识与一致性（强约束）

- **资源 ID 统一**：建议 `namespace.kind.name`（例如 `ui.icon.torch`、`tile.dirt`、`font.ui.default`）。
- **引用只用 ID**：代码与数据定义中禁止直接硬编码文件系统路径作为运行期引用。
- **指纹稳定**：
  - 指纹输入 = 资源清单 + 每个条目内容哈希 + 关键构建参数（压缩算法、纹理格式等）。
  - 指纹输出 = 稳定字符串（建议 SHA-256 十六进制）。

## 输出形态（建议）

- `ResourceManifest`（JSON 或二进制均可）：
  - `format_version`
  - `build_fingerprint`
  - 条目列表：`id`、`type`、`content_hash`、`offset/size` 或 `relative_path`、运行期元信息（尺寸、九宫格边距、基线等）
- `ResourcePack`（单文件或目录）：
  - 单文件更利于校验与分发；目录更利于调试与快速迭代。
  - 两者可共存：Debug 用目录，Release 用 pack。

## 与 UI 系统的接口

- UI 不直接读取文件：UI 只消费 “资源句柄/纹理 ID -> 可渲染对象”的映射。
- 若 overlay 渲染能力扩展为 `Sprite/NineSlice`：
  - `RenderCommand` 只携带 `resource_id`（或运行期句柄），不携带文件路径。
  - 渲染后端只做查表与绘制，不做解析。

